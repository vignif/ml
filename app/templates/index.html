<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Neural Style Transfer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="{{ prefix }}/static/style.css" />
</head>
<body>
  <header>
    <h1>Neural Style Transfer</h1>
  </header>
  <main>
    <div class="layout">
      <div class="card">
        <h2>Input</h2>
        <form id="style-form" method="post" enctype="multipart/form-data" action="{{ prefix }}/stylize">
          <label>Content Image
            <input required type="file" name="content_image" accept="image/*" />
          </label>
          <div class="drop-zone" id="content-drop">Drag & Drop Content Image</div>
          <label>Style Image
            <input required type="file" name="style_image" accept="image/*" />
          </label>
          <div class="drop-zone" id="style-drop">Drag & Drop Style Image</div>
          <label>Steps (50-500)
            <input type="number" name="steps" value="200" min="50" max="600" />
          </label>
          <label>Style Weight (1e5 - 1e8)
            <input type="number" name="style_weight" value="1000000" step="100000" />
          </label>
          <button type="submit">Stylize</button>
          <div class="hint">Processing uses iterative optimization; higher steps = more style fidelity.</div>
          <div id="progress"></div>
          <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
          <button id="cancel-btn" type="button" style="display:none; margin-top:.6rem; background:#b91c1c; border:1px solid #7f1d1d;">Cancel</button>
        </form>
      </div>
      <div class="card">
        <h2>Result</h2>
        <div id="result"></div>
      </div>
    </div>
  </main>
  <footer>
    Built by <a href="https://apps.francescovigni.com" target="_blank" rel="noopener">Francesco Vigni</a>. Source available in this instance. Â© <span id="year"></span>
  </footer>
<script>
const form = document.getElementById('style-form');
const progressDiv = document.getElementById('progress');
const progressBar = document.getElementById('progress-bar');
document.getElementById('year').textContent = new Date().getFullYear();

function setupDropZone(zoneId, inputName) {
  const zone = document.getElementById(zoneId);
  const input = form.querySelector(`input[name="${inputName}"]`);
  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      input.files = e.dataTransfer.files;
      zone.textContent = 'Selected: ' + e.dataTransfer.files[0].name;
    }
  });
}
setupDropZone('content-drop', 'content_image');
setupDropZone('style-drop', 'style_image');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = '';
  progressDiv.classList.add('loading');
  progressDiv.textContent = 'Uploading & starting job...';
  try {
  // Build target respecting potential missing leading slash
  let target = '{{ prefix }}/stylize';
  if (!target.startsWith('/')) target = '/' + target; // ensure absolute path
    const resp = await fetch(target, { method: 'POST', body: fd });
    if(!resp.ok) throw new Error('Failed to enqueue: ' + resp.status);
  const { job_id } = await resp.json();
  progressDiv.textContent = 'Job queued...';
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = `<div class="loading-shell" id="loading-shell"><div class="pulse-ring"></div></div>`;
  progressBar.style.width = '0%';
  const cancelBtn = document.getElementById('cancel-btn');
  cancelBtn.style.display='inline-block';
  cancelBtn.onclick = () => cancelJob(job_id, cancelBtn);
  await pollJob(job_id, resultDiv, progressDiv, cancelBtn);
  } catch (err) {
    progressDiv.textContent = 'Error: ' + err.message;
  }
});

async function pollJob(jobId, resultDiv, progressDiv, cancelBtn) {
  let prefix = '{{ prefix }}';
  if (prefix && !prefix.startsWith('/')) prefix = '/' + prefix;
  const base = prefix || '';
  while (true) {
    const r = await fetch(`${base}/stylize/${jobId}`);
    if (r.status === 404) { progressDiv.textContent = 'Job not found.'; cancelBtn.style.display='none'; return; }
    const ct = r.headers.get('content-type') || '';
  if (ct.startsWith('image/')) { const blob = await r.blob(); const url = URL.createObjectURL(blob); progressDiv.textContent = 'Done.'; progressDiv.classList.remove('loading'); resultDiv.innerHTML = `<h2>Result</h2><img class="result-image fade-in" src="${url}" />`; cancelBtn.style.display='none'; return; }
    const data = await r.json();
    if (data.status === 'error') { progressDiv.textContent = 'Error: ' + data.error; cancelBtn.style.display='none'; return; }
    if (data.status === 'cancelled') { progressDiv.textContent = 'Cancelled.'; cancelBtn.style.display='none'; return; }
    let pct = 0;
    if (data.total_steps) pct = (data.step / data.total_steps) * 100;
    let eta = '';
    if (data.eta_seconds !== null && data.eta_seconds !== undefined) {
      const mins = Math.floor(data.eta_seconds / 60);
      const secs = Math.round(data.eta_seconds % 60);
      eta = ` | ETA: ${mins}m ${secs}s`;
    }
  progressDiv.textContent = `Step ${data.step}/${data.total_steps} (${pct.toFixed(1)}%)${eta}`;
  if (pct > 2) {
    const shell = document.getElementById('loading-shell');
    if (shell) shell.innerHTML = '<div class="spinner"></div>';
  }
  progressBar.style.width = `${pct}%`;
  if (data.preview_step && data.preview_step === data.step) {
    try {
      const pr = await fetch(`${base}/stylize/${jobId}/preview`);
      if (pr.ok && pr.status === 200 && (pr.headers.get('content-type')||'').startsWith('image/')) {
        const blobPrev = await pr.blob();
        const urlPrev = URL.createObjectURL(blobPrev);
        let pv = document.getElementById('live-preview');
        if (!pv) {
          pv = document.createElement('img');
          pv.id = 'live-preview';
          pv.className='result-image loading';
          pv.style.opacity='0.85';
          pv.title='Intermediate Preview';
          resultDiv.innerHTML = '<h2>Preview</h2>';
          resultDiv.appendChild(pv);
        }
        pv.src = urlPrev;
        pv.classList.remove('loading');
      }
    } catch {}
  }
    await new Promise(res => setTimeout(res, 1500));
  }
}

async function cancelJob(jobId, btn){
  let prefix='{{ prefix }}';
  if(prefix && !prefix.startsWith('/')) prefix='/'+prefix;
  const base = prefix || '';
  btn.disabled = true; btn.textContent='Cancelling...';
  try { await fetch(`${base}/stylize/${jobId}/cancel`, { method:'POST' }); } catch {}
}
</script>
</body>
</html>
